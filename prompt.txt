
“

You must complete the implementation of an I²C master controller in sources/ . The design is driven by a simple command interface and must perform I²C READ transactions of N bytes (N ≥ 1) using 7-bit addressing and open-drain SDA.


Host interface (top module ports)

Top module: i2c_master_top

Inputs:

clk

rst_n (active-low reset)

cmd_start (1-cycle pulse to start a transaction)

cmd_addr[6:0] (7-bit I²C address)

cmd_len[7:0] (number of bytes to read; valid range 1..255)

Outputs:

busy (high while transaction in progress)

done (1-cycle pulse when transaction completes, whether success or NACK)

ack_error (asserted if slave NACKs address; cleared on new cmd_start or reset)

rdata[7:0] (received byte)

rvalid (1-cycle pulse when rdata is valid; must pulse exactly cmd_len times on success)

I²C pins (split SDA, open drain):

scl (output, master-driven)

sda_o (output value; only meaningful when sda_oe=1)

sda_oe (output enable; 1=drive SDA low, 0=release SDA)

sda_i (input sample of SDA line)

Open-drain rule: master must never drive SDA high.

To drive 0: sda_oe=1 and sda_o=0

To release line: sda_oe=0 (line pulled up externally)

Transaction to implement

On cmd_start:

Generate START condition:

While scl is high, SDA transitions 1→0 (i.e., release SDA high, then pull low).

Send address + READ bit:

Shift out 7-bit address MSB-first, then R/W bit = 1.

Data bit timing rule: SDA may only change when SCL is low and must be stable while SCL is high.

Address ACK bit (9th clock):

Master releases SDA (sda_oe=0).

Sample sda_i during SCL high of the ACK bit:

ACK = 0, NACK = 1

If NACK: set ack_error=1, generate STOP, pulse done, deassert busy. No rvalid pulses.

Read cmd_len data bytes:
For each byte i = 0..cmd_len-1:

Slave drives 8 data bits; master must keep SDA released during these 8 bits.

Master samples each data bit at the rising edge of SCL (or equivalently during SCL-high; but implement sampling on rising edge).

After 8 bits, master drives ACK/NACK on the 9th clock:

If i < cmd_len-1: master drives ACK=0 (pull SDA low during ACK bit)

If i == cmd_len-1: master drives NACK=1 (release SDA during ACK bit)

Generate STOP after final NACK:

While SCL high, SDA transitions 0→1 (release SDA high).

Clocking / timing (simplified)

The design must internally generate SCL by dividing clk. A parameter CLK_DIV is provided in the skeleton (or define one). It sets the number of clk cycles per SCL half-period. The test expects stable behavior but is tolerant of exact frequency as long as the waveform is consistent.

Unsupported features

No repeated start

No clock stretching (ignore; do not wait for SCL held low by slave)

No multi-master arbitration
”